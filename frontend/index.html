<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background-color: #f0f4f8;
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #1a73e8;
            margin-bottom: 20px;
        }

        .search-section {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .search-section input {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            flex: 1;
            min-width: 200px;
        }

        .search-section button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background-color: #1a73e8;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-section button:hover {
            background-color: #1557b0;
        }

        .forecast-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .weather-result, .history-section {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .weather-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .history-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }

        .loading {
            text-align: center;
            font-size: 18px;
            color: #1a73e8;
            display: none;
            margin: 20px 0;
        }

        .loading::after {
            content: ".";
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0% { content: "."; }
            33% { content: ".."; }
            66% { content: "..."; }
        }

        canvas {
            margin: 20px 0;
            max-width: 100%;
        }

        @media (max-width: 600px) {
            .search-section {
                flex-direction: column;
                align-items: center;
            }

            .search-section input, .search-section button {
                width: 100%;
                max-width: 300px;
            }

            .forecast-buttons {
                flex-direction: column;
            }

            .forecast-buttons button {
                width: 100%;
                max-width: 300px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>Weather Service</h1>

        <div class="search-section">
            <input type="text" id="cityInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Moscow)" />
            <button onclick="searchWeather()">–ü–æ–∏—Å–∫</button>
        </div>

        <div class="forecast-buttons">
            <button onclick="setForecastDays(7)">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 7 –¥–Ω–µ–π</button>
            <button onclick="setForecastDays(14)">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 14 –¥–Ω–µ–π</button>
            <button onclick="setForecastDays(30)">–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ 30 –¥–Ω–µ–π</button>
            <button onclick="showHistory()">–ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        </div>

        <div class="loading" id="loading">–ó–∞–≥—Ä—É–∑–∫–∞</div>
        <div class="weather-result" id="weatherResult"></div>
        <canvas id="temperatureChart" style="display: none;"></canvas>
        <div class="history-section" id="historySection"></div>
    </div>

    <script>
        const BACKEND_URL = "";
        let forecastDays = 0;
        let chart = null;

        
        const WEATHER_EMOJIS = {
            "clear": "‚òÄÔ∏è",
            "clouds": "‚òÅÔ∏è",
            "rain": "üåßÔ∏è",
            "light rain": "üå¶Ô∏è",
            "moderate rain": "üåßÔ∏è",
            "heavy rain": "‚õàÔ∏è",
            "snow": "‚ùÑÔ∏è",
            "thunderstorm": "‚õàÔ∏è",
            "mist": "üå´Ô∏è",
            "drizzle": "üå¶Ô∏è",
            "broken clouds": "‚òÅÔ∏è",
            "scattered clouds": "üå•Ô∏è",
            "few clouds": "üå§Ô∏è",
            "overcast clouds": "‚òÅÔ∏è"
        };

       
        function getWeatherEmoji(description) {
            const desc = description.toLowerCase();
            
            if (WEATHER_EMOJIS[desc]) {
                return WEATHER_EMOJIS[desc];
            }
            
            if (desc.includes("rain")) return "üåßÔ∏è";
            if (desc.includes("cloud")) return "‚òÅÔ∏è";
            if (desc.includes("clear")) return "‚òÄÔ∏è";
            if (desc.includes("snow")) return "‚ùÑÔ∏è";
            if (desc.includes("thunder")) return "‚õàÔ∏è";
            if (desc.includes("mist") || desc.includes("fog")) return "üå´Ô∏è";
            if (desc.includes("drizzle")) return "üå¶Ô∏è";
            return "üå¶Ô∏è";
        }

        function getFlagEmoji(countryCode) {
            if (!countryCode) return "";
            try {
                const offset = 127397;
                return String.fromCodePoint(countryCode.charCodeAt(0) + offset) +
                       String.fromCodePoint(countryCode.charCodeAt(1) + offset);
            } catch (e) {
                return "";
            }
        }

        
        function toggleLoading(show) {
            document.getElementById("loading").style.display = show ? "block" : "none";
        }

        async function searchWeather() {
            const cityInput = document.getElementById("cityInput").value.trim();
            if (!cityInput) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞.");
                return;
            }

            toggleLoading(true);
            const weatherResult = document.getElementById("weatherResult");
            const temperatureChart = document.getElementById("temperatureChart");
            weatherResult.innerHTML = "";
            temperatureChart.style.display = "none";

            try {
                const url = `/forecast/${cityInput}${forecastDays ? `?days=${forecastDays}&` : "?"}lang=ru`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const countryCode = data.country || "RU";
                const flagEmoji = getFlagEmoji(countryCode);

                let html = `<h3>${flagEmoji} –ü–æ–≥–æ–¥–∞ –≤ ${data.city}</h3>`;
                const temperatures = [];
                const dates = [];

                data.forecast.forEach(forecast => {
                    const description = forecast.description.toLowerCase();
                    const weatherEmoji = getWeatherEmoji(description);
                    html += `
                        <div class="weather-card">
                            <span>${weatherEmoji}</span>
                            <span>${forecast.date}</span>
                            <span>${forecast.description}</span>
                            <span>${forecast.temperature}¬∞C</span>
                        </div>
                    `;
                    temperatures.push(forecast.temperature);
                    dates.push(forecast.date.split(" ")[0]);
                });

                weatherResult.innerHTML = html;

                if (chart) chart.destroy();
                temperatureChart.style.display = "block";
                const ctx = temperatureChart.getContext("2d");
                chart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: dates,
                        datasets: [{
                            label: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)",
                            data: temperatures,
                            borderColor: "#1a73e8",
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: { display: true, text: "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (¬∞C)" }
                            },
                            x: {
                                title: { display: true, text: "–î–∞—Ç–∞" }
                            }
                        }
                    }
                });

                const history = JSON.parse(localStorage.getItem("weatherHistory")) || [];
                history.unshift({
                    city: data.city,
                    date: new Date().toISOString(),
                    forecast: data.forecast.slice(0, 1)
                });
                localStorage.setItem("weatherHistory", JSON.stringify(history.slice(0, 10)));

            } catch (error) {
                weatherResult.innerHTML = `<p>–û—à–∏–±–∫–∞: ${error.message}</p>`;
            } finally {
                toggleLoading(false);
            }
        }

        function setForecastDays(days) {
            forecastDays = days;
            searchWeather();
        }

        async function showHistory() {
            toggleLoading(true);
            const historySection = document.getElementById("historySection");
            historySection.innerHTML = "";

            try {
                const response = await fetch(`/weather_history?limit=10`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                let html = "<h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞</h3>";
                data.history.forEach(entry => {
                    const countryCode = "RU";
                    const flagEmoji = getFlagEmoji(countryCode);
                    const description = entry.description.toLowerCase();
                    const weatherEmoji = getWeatherEmoji(description);
                    html += `
                        <div class="history-item">
                            <p>${flagEmoji} –ì–æ—Ä–æ–¥: ${entry.city}</p>
                            <p>–î–∞—Ç–∞: ${entry.forecast_date}</p>
                            <p>${weatherEmoji} –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${entry.avg_temperature}¬∞C, ${entry.description}</p>
                            <p>–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: ${entry.request_time}</p>
                        </div>
                    `;
                });

                const localHistory = JSON.parse(localStorage.getItem("weatherHistory")) || [];
                if (localHistory.length > 0) {
                    html += "<h3>–õ–æ–∫–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è</h3>";
                    localHistory.forEach(entry => {
                        const forecast = entry.forecast[0];
                        const description = forecast.description.toLowerCase();
                        const weatherEmoji = getWeatherEmoji(description);
                        html += `
                            <div class="history-item">
                                <p>–ì–æ—Ä–æ–¥: ${entry.city}</p>
                                <p>–î–∞—Ç–∞: ${forecast.date}</p>
                                <p>${weatherEmoji} –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${forecast.temperature}¬∞C, ${forecast.description}</p>
                                <p>–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞: ${entry.date}</p>
                            </div>
                        `;
                    });
                }

                historySection.innerHTML = html;

            } catch (error) {
                historySection.innerHTML = `<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}</p>`;
            } finally {
                toggleLoading(false);
            }
        }

        document.getElementById("cityInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter") {
                searchWeather();
            }
        });
    </script>
</body>
</html>